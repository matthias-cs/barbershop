<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Fingerprint Auth Demo</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f7f7f7;
      text-align: center;
      padding: 50px;
    }
    h1 {
      color: #333;
    }
    .btn {
      background: #4CAF50;
      border: none;
      color: white;
      padding: 15px 32px;
      text-align: center;
      font-size: 16px;
      margin: 10px;
      cursor: pointer;
      border-radius: 8px;
      transition: background 0.3s ease;
    }
    .btn:hover {
      background: #45a049;
    }
    #output {
      margin-top: 20px;
      font-size: 18px;
      font-weight: bold;
      color: #333;
    }
  </style>
</head>
<body>
  <h1>Fingerprint Authentication Demo</h1>

  <!-- Button to register the fingerprint credential -->
  <button class="btn" onclick="registerFingerprint()">Register Fingerprint</button>
  <!-- Button to trigger fingerprint authentication -->
  <button class="btn" onclick="authenticateFingerprint()">Authenticate Fingerprint</button>

  <p id="output"></p>

  <script>
    // Global storage for the registered credential
    let registeredCredential = null;

    // Utility functions to convert between ArrayBuffers and Base64URL strings
    function bufferToBase64(buffer) {
      const bytes = new Uint8Array(buffer);
      let binary = '';
      for (let i = 0; i < bytes.byteLength; i++) {
        binary += String.fromCharCode(bytes[i]);
      }
      return window.btoa(binary)
        .replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
    }

    function base64ToBuffer(base64) {
      const padding = '='.repeat((4 - base64.length % 4) % 4);
      const base64Str = (base64 + padding).replace(/-/g, '+').replace(/_/g, '/');
      const rawData = window.atob(base64Str);
      const buffer = new ArrayBuffer(rawData.length);
      const uint8Array = new Uint8Array(buffer);
      for (let i = 0; i < rawData.length; i++) {
        uint8Array[i] = rawData.charCodeAt(i);
      }
      return buffer;
    }

    // Fingerprint Registration:
    async function registerFingerprint() {
      const output = document.getElementById('output');

      // Create a random challenge
      const challenge = window.crypto.getRandomValues(new Uint8Array(32));

      const publicKey = {
        challenge: challenge,
        rp: { name: "Barbershop Auth" },
        user: {
          id: Uint8Array.from("owner123", c => c.charCodeAt(0)),
          name: "owner@example.com",
          displayName: "Barbershop Owner"
        },
        pubKeyCredParams: [
          { type: "public-key", alg: -7 } // ES256 algorithm
        ],
        authenticatorSelection: {
          authenticatorAttachment: "platform", // use in-built authenticator
          userVerification: "required"
        },
        timeout: 60000,
        attestation: "none" // 'none' minimizes data exchange for demo purposes
      };

      try {
        const credential = await navigator.credentials.create({ publicKey });
        registeredCredential = credential;
        output.innerText = "Fingerprint registered successfully.";
        console.log("Registered Credential:", credential);
      } catch (err) {
        output.innerText = "Registration failed: " + err;
        console.error("Error in registration:", err);
      }
    }

    // Fingerprint Authentication:
    async function authenticateFingerprint() {
      const output = document.getElementById('output');
      
      if (!registeredCredential) {
        output.innerText = "Please register your fingerprint first.";
        return;
      }

      // Use the rawId from the registered credential to form allowCredentials
      const allowCredentials = [{
        type: "public-key",
        id: registeredCredential.rawId,
        transports: ["internal"]
      }];

      // Create a fresh challenge
      const challenge = window.crypto.getRandomValues(new Uint8Array(32));

      const publicKey = {
        challenge: challenge,
        timeout: 60000,
        allowCredentials: allowCredentials,
        userVerification: "required"
      };

      try {
        const assertion = await navigator.credentials.get({ publicKey });
        // For our demo, a successful assertion indicates correct fingerprint.
        output.innerText = "Fingerprint authentication successful!";
        console.log("Authentication Assertion:", assertion);
      } catch (err) {
        output.innerText = "Authentication failed: " + err;
        console.error("Error in authentication:", err);
      }
    }
  </script>
</body>
</html>
